---
title: "Texas Covid Time Series PLots"
author: "The Covid Project and Craig Slinkman"
date: "7/25/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Texas Covid Data Plots

This RMarkdown document plots the time series data provided by 
[The Covid Project](https://covidtracking.com).

```{r load_packages}
require(tidyverse)                          # I live in the tidyverse ...
require(lubridate)                          # For advanced date processing ...
require( cowplot )                          # For academic plotting ...
require(formattable)                        # For fixed decimal formatting ...
require( tidyr )                            # To convert wide to long-form data
```
 
## Load required_functions

```{r load_required functions}
source('D:/R-Projects/TexasCovid/functions/get_texas_daily_covid_data.R')
source('D:/R-Projects/TexasCovid/functions/determine_plot_period.R')
source('D:/R-Projects/TexasCovid/functions/plot_ts.R')
source('D:/R-Projects/TexasCovid/functions/capitalize_strings.R')
 
```

## Prepare for plotting


The default theme in ggplot produces a high ratio of ink to data points.  Therefore, I prefer to use the cowplot theme.  We loaded the theme in load packages chunk but we need to set here.

```{r prepare_for_plotting}

#########################################################################################
# Note: As of version 1.0.0, cowplot does not change the default ggplot2 theme
# anymore. To recover the previous behavior, execute:
# theme_set(theme_cowplot())
#########################################################################################

theme_set(theme_cowplot())


##############################################################################
# We are going to a color blind pallette sugest in Winston's R Cookbook.
# can find is palette  at http://www.cookbook-r.com/Graphs/Colors_(ggplot2)/.
# We use the black which is defined below.
###############################################################################
 
cbbPalette <- c("#000000",  # black
                "#E69F00",   # University of Texas orange
                "#009E73",   # Green
                "#F0E442",   # Yellow
                "#0072B2",   # Dark blue
                "#D55E00",   # Firebrick red
                "#CC79A7 " ) # Pinkish purple

###############################################################################
# Activate black color blind palette for manual fill and manual points and
# lines.
###############################################################################

scale_fill_manual( values = cbbPalette )
scale_color_manual( values = cbbPalette )

```
 
## Get the Texas Covid data

We read the data from the Covid Project data.

```{r get_daily_covid_data}

###############################################################################
# We get the covid data using the functions/get_texas_daily_covid_data.
###############################################################################

texas <- get_texas_daily_covid_data()
period <- determine_plot_period( texas )


###############################################################################
# Determine the plot period.
###############################################################################
```

## Graphical Analysis of Tests

This section reports the analysis of the Texas testing results.

### Positive tests

#### Definition of a positive test

Total number of people with confirmed OR probable COVID-19 reported by the state or territory (per the expanded CSTE case definition of April 5th, 2020 approved by the CDC). A confirmed case is a person who has a positive test result from an FDA approved diagnostic molecular test. A probable case is a person who either has presentable symptoms WITH epidemiological evidence or has BOTH a positive presumptive laboratory test AND also EITHER presentable symptoms OR epidemiological evidence. Epidemiological evidence refers either to close-proximity contact with a known case or travel history to an area with high disease incidence. According to the guidelines, FDA approved antibody and antigen tests are considered part of presumptive laboratory evidence.

#### Positive test plot

```{r plot_positive_cases}

#####################################################################
# We compute y-axis tick marks.  Noe that the positive case variable is in the
# third column.
#####################################################################

variable <- "positive"
variable_name <- "Cummulative positive tests"
title   <- paste( "Texas nCovid-19 positive tests\n",
                  "From", period[1], "to", period[2] )

plot_ts( texas,
         variable,
         variable_name,
         title )
   
```

### Negative test cases

#### Definition of negative test

Individuals with a completed viral test that returned a negative result. For states / territories that do not report this number directly, we compute it using one of several methods, depending on which data points the state provides.  

#### Time series plot of negative tests

```{r plot_negative_cases}

variable <- "negative"
variable_name <-  "Cummulative negative tests"
title   <- paste( "Texas nCovid-19 negative tests\n",
                  "From", period[1], "to", period[2] )
 
plot_ts( texas,
         variable,
         variable_label,
         title )
```

### All tests

#### Definition of all tests

All tests are the sum the positive tests and the negative test.  This is a derived value
and is not in the original data.

#### Cummaltive number of trests

Note these value does not include pending tests.

```{r plot_all}

texas <- 
   texas %>% 
      mutate( all <- positive + negative )  
        
variable       <- "all"
variable_label <-"Cummulative tests"
title   <- paste( "Texas nCovid-19 tests\n",
                  "From", period[1], "to", period[2] )
plot_ts( texas,
         variable,
         variable_name,
         title )

```

###  Simultaneous overlaid plots of negative tests, positive tests, and all

```{r plot_all}

###############################################################################
# Extract from the texas tibble the information needed for the multiple-line
# plot.  Then compute the total tests for the day.
###############################################################################

temp <-
   texas %>% 
      select( date, positive, negative ) %>%
         mutate( all = positive + negative )

##############################################################################
# Get variable names from the tibble, change the first letter to a capital,
# and replace the names in the temp tibble.
##############################################################################

vnames <- names( temp )
vnames <- capitalize_strings( vnames )
names( temp )  <- vnames


##############################################################################
# Convert wide-form to long-form data by pivot to longer function. 
##############################################################################

temp <- pivot_longer( temp,
                        cols = c( "Positive",
                                  "Negative",
                                  "All" ),
                        names_to = "Tests" )

this_title <- paste("Texas Cummulative nCovid-19 tests results",
                    "\nfrom", period[1], "through", period[2] )
                     

ggplot( temp,
        aes( x = Date, y = value, color = Tests)) +
   geom_line( linesize =3 ) +
   scale_x_date( name = "Date",
                         date_labels = "%Y-%m" ) +
   ylab( "Tests" ) + 
   scale_color_manual ( values = c(  "#000000",      # All
                                     "#009E73",      # Red
                                     "#D55E00"  )) + # Blue
   ggtitle( this_title )

```

###  Percent positive tests

```{r plot_percen_tpositive_tests}

temp <- 
   texas %>% 
      mutate( percent = positive / ( positive + negative )) %>% 
         select( date, percent )


###############################################################################
# Set column names for output
###############################################################################

names(temp)  <- capitalize_strings( names( temp))

this_title  <- paste( "Texas nCovid-19 percent positive test\n",
                      "from", period[1], "through", period[2] )
                              

ggplot( temp,
        aes( x = Date, y = Percent )) +
   geom_line() +
   scale_x_date( name = "Date",
                         date_labels = "%Y-%m" ) +
    scale_y_continuous(labels = scales::percent_format(accuracy =1 )) +
   ggtitle( this_title )

   
```
