---
title: "Texas Covid Time Series PLots"
author: "The Covid Project and Craig Slinkman"
date: "7/25/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Texas Covid Data Plots

This RMarkdown document plots the time series data provided by 
[The Covid Project](https://covidtracking.com).

```{r load_packages}
require(tidyverse)                          # I live in the tidyverse ...
require(lubridate)                          # For advanced date processing ...
require( cowplot )                          # For academic plotting ...
require(formattable)                        # For fixed decimal formatting ...
require( tidyr )                            # To convert wide to long-form ...
require( scales )                           # For formatting date scales ...
```
 
## Load required_functions

```{r load_required functions}
source('D:/R-Projects/TexasCovid/functions/get_texas_daily_covid_data.R')
source('D:/R-Projects/TexasCovid/functions/determine_plot_period.R')
source('D:/R-Projects/TexasCovid/functions/plot_ts.R')
source('D:/R-Projects/TexasCovid/functions/capitalize_strings.R')
 
```

## Prepare for plotting


The default theme in ggplot produces a high ratio of ink to data points.  Therefore, I prefer to use the cowplot theme.  We loaded the theme in load packages chunk but we need to set here.

```{r prepare_for_plotting}

#########################################################################################
# Note: As of version 1.0.0, cowplot does not change the default ggplot2 theme
# anymore. To recover the previous behavior, execute:
# theme_set(theme_cowplot())
#########################################################################################

theme_set(theme_cowplot())


##############################################################################
# We are going to a color blind pallette sugest in Winston's R Cookbook.
# can find is palette  at http://www.cookbook-r.com/Graphs/Colors_(ggplot2)/.
# We use the black which is defined below.
###############################################################################
 
cbbPalette <- c("#000000",  # black
                "#E69F00",   # University of Texas orange
                "#009E73",   # Green
                "#F0E442",   # Yellow
                "#0072B2",   # Dark blue
                "#D55E00",   # Firebrick red
                "#CC79A7 " ) # Pinkish purple

###############################################################################
# Activate black color blind palette for manual fill and manual points and
# lines.
###############################################################################

scale_fill_manual( values = cbbPalette )
scale_color_manual( values = cbbPalette )

```
 
## Get the Texas Covid data

We read the data from the Covid Project data.

```{r get_daily_covid_data}

###############################################################################
# We get the covid data using the functions/get_texas_daily_covid_data.
###############################################################################

texas <- get_texas_daily_covid_data()
period <- determine_plot_period( texas )

```

## Graphical Analysis of Tests

This section reports the analysis of the Texas testing results.

### Positive tests

#### Definition of a positive test

Total number of people with confirmed OR probable COVID-19 reported by the state or territory (per the expanded CSTE case definition of April 5th, 2020 approved by the CDC). A confirmed case is a person who has a positive test result from an FDA approved diagnostic molecular test. A probable case is a person who either has presentable symptoms WITH epidemiological evidence or has BOTH a positive presumptive laboratory test AND also EITHER presentable symptoms OR epidemiological evidence. Epidemiological evidence refers either to close-proximity contact with a known case or travel history to an area with high disease incidence. According to the guidelines, FDA approved antibody and antigen tests are considered part of presumptive laboratory evidence.

#### Positive test plot

```{r plot_positive_cases}

#####################################################################
# We compute y-axis tick marks.  Noe that the positive case variable is in the
# third column.
#####################################################################

this_title   <- paste( "Texas nCovid-19 positive tests\n",
                       "From", period[1], "to", period[2] )

ggplot( texas,
        aes( x = date, positive)) +
   geom_line() +
   scale_x_date( name = "Date",
                 date_breaks = "1 month",
                 date_labels = "%Y-%m" ) +
   ylab( "Positive tests" ) +
   theme(axis.text.x=element_text(angle=60, hjust=1)) +
   ggtitle( this_title )
     
```

### Negative test cases

#### Definition of negative test

Individuals with a completed viral test that returned a negative result. For states / territories that do not report this number directly, we compute it using one of several methods, depending on which data points the state provides.  

#### Time series plot of negative tests

```{r plot_negative_cases}

this_title   <- paste( "Texas nCovid-19 negative tests\n",
                       "From", period[1], "to", period[2] )

ggplot( texas,
        aes( x = date,negative )) +
   geom_line() +
   scale_x_date( name = "Date",
                 date_breaks = "1 month",
                 date_labels = "%Y-%m" ) +
   ylab( "Nositive tests" ) +
   theme(axis.text.x=element_text(angle=60, hjust=1)) +
   ggtitle( this_title )

```

### All tests

#### Definition of all tests

All tests are the sum the positive tests and the negative test.  This is a derived value
and is not in the original data.

#### Cummaltive number of trests

Note these value does not include pending tests.

```{r plot_al_tests}

texas <- 
   texas %>% 
      mutate( Tests  <- positive + negative )  
        
this_title   <- paste( "Texas nCovid-19 All tests with reported results\n",
                        "From", period[1], "to", period[2] )

ggplot( texas,
        aes( x = date,negative )) +
   geom_line() +
   scale_x_date( name = "Date",
                 date_breaks = "1 month",
                 date_labels = "%Y-%m" ) +
   ylab( "Tests with reported results" ) +
   theme(axis.text.x=element_text(angle=60, hjust=1)) +
   ggtitle( this_title )

```

###  Simultaneous overlaid plots of negative tests, positive tests, and all

```{r plot_all_1}

########################################################################################
# Extract from the texas tibble the information needed for the multiple-line
# plot.  Then compute the total tests for the day.
########################################################################################

temp <-
   texas %>% 
      select( date, positive, negative ) %>%
         mutate( all = positive + negative )

##############################################################################
# Get variable names from the tibble, change the first letter to a capital,
# and replace the names in the temp tibble.
##############################################################################

vnames <- names( temp )
vnames <- capitalize_strings( vnames )
names( temp )  <- vnames


##############################################################################
# Convert wide-form to long-form data by pivot to longer function. 
##############################################################################

temp <- pivot_longer( temp,
                        cols = c( "Positive",
                                  "Negative",
                                  "All" ),
                        names_to = "Tests" )

this_title <- paste("Texas Cummulative nCovid-19 tests results",
                    "\nfrom", period[1], "through", period[2] )
                     

ggplot( temp,
        aes( x = Date, y = value, color = Tests)) +
   geom_line( linesize =3 ) +
   scale_x_date( name = "Date",
                         date_labels = "%Y-%m" ) +
   ylab( "Tests" ) + 
   scale_color_manual ( values = c(  "#000000",      # All
                                     "#009E73",      # Red
                                     "#D55E00"  )) + # Blue
    theme(axis.text.x=element_text(angle=60, hjust=1)) +
   ggtitle( this_title )

```

###  Percent positive tests

```{r plot_percen_tpositive_tests}

temp <- 
   texas %>% 
      mutate( percent = positive / ( positive + negative )) %>% 
         select( date, percent )


###############################################################################
# Set column names for output
###############################################################################

names(temp)  <- capitalize_strings( names( temp))

this_title  <- paste( "Texas nCovid-19 percent positive test\n",
                      "from", period[1], "through", period[2] )
                              

ggplot( temp,
        aes( x = Date, y = Percent )) +
   geom_line() +
   scale_x_date( name = "Date",
                         date_labels = "%Y-%m" ) +
    scale_y_continuous(labels = scales::percent_format(accuracy =1 )) +
    theme(axis.text.x=element_text(angle=60, hjust=1)) +
    ggtitle( this_title )

   
```

### Pending

API field name: pending

#### Definition

Total number of viral tests that have not been completed as reported by the state or territory.

This data is not available for the state of Texas.  Therefore, we can not present the time series plot of this data.

### Hospitalized currently

#### Definition

Individuals who are currently hospitalized with COVID-19. Definitions vary by state / territory. Where possible, we report hospitalizations with confirmed or probable COVID-19 cases per the expanded [CSTE case definition](https://cdn.ymaws.com/www.cste.org/resource/resmgr/2020ps/Interim-20-ID-01_COVID-19.pdf) of April 5th, 2020 [approved by the CDC](https://wwwn.cdc.gov/nndss/conditions/coronavirus-disease-2019-covid-19/case-definition/2020/).

#### Time series plot

```{r plot_ts_hospitalizedCurrently}

this_title  <- paste( "Texas nCovid-19 Current hospitalizations\n",
                      "from", period[1], "through", period[2] )
y_labels = seq( from = 0, to = 11000, by= 1000 )
                              

ggplot( texas,
        aes( x = date, y = hospitalizedCurrently )) +
   geom_line() +
   scale_x_date( name = "Date",
                         date_labels = "%Y-%m" ) +
   scale_y_continuous( name = "Current hospitalizations",
                       labels = y_labels,
                       breaks = y_labels ) +
   ggtitle( this_title ) +
   theme(axis.text.x=element_text(angle=60, hjust=1)) +
   theme_cowplot()


```

### Cumulative hospitalized

#### DefinitionAPI field name: hospitalizedCumulative

Total number of individuals who have ever been hospitalized with COVID-19. Definitions vary by state / territory. Where possible, we report hospitalizations with confirmed or probable COVID-19 cases per the expanded [CSTE case definition](https://cdn.ymaws.com/www.cste.org/resource/resmgr/2020ps/Interim-20-ID-01_COVID-19.pdf) of April 5th, 2020 [approved by the CDC](https://wwwn.cdc.gov/nndss/conditions/coronavirus-disease-2019-covid-19/case-definition/2020/).

This  variable is not provided.  We can't compute it because given the data we have we can't avoid double counting individuals who are hospitalized for more than one day.

#### Cummulative hospitalizations time series  

Note that this data while present in the variable definitions is not provided in the data.  This is
probably due to the problem of double counting patients.  We can't compute it with out counting a patient more than one given the data we are given.


### In ICU currently

#### Definition

API field name: **inICUCurrently**

Individuals who are currently hospitalized in the Intensive Care Unit with COVID-19. Definitions vary by state / territory. Where possible, we report patients in the ICU with confirmed or probable COVID-19 cases per the expanded CSTE case definition of April 5th, 2020 approved by the CDC.

Note that this data was not recorded until very recently.  That is why the time series plot is relatively empty.


#### Time series plot
 
```{r plot_inIcuCurrently}


this_title  <- paste( "Texas nCovid-19 cases in ICU Currently\n",
                      "from", period[1], "through", period[2] )

y_labels = seq( from = 0, to = 4000, by= 500 )
                              

ggplot( texas,
        aes( x = date, y =inIcuCurrently )) +
   geom_line() +
   scale_x_date( name = "Date",
                         date_labels = "%Y-%m" ) +
  scale_y_continuous( name = "Cases",
                      limits = c(0, 4000)) +
   ggtitle( this_title ) +
   theme(axis.text.x=element_text(angle=60, hjust=1)) +
   theme_cowplot()

```
 
### InIcuCumulative 

#### Definition Cumulative hospitalized  

API field name: Cumulative hospitalizations

Total number of individuals who have ever been hospitalized with COVID-19. Definitions vary by state or territory. Where possible, we report hospitalizations with confirmed or probable COVID-19 cases per the expanded CSTE case definition of April 5th, 2020 approved by the CDC.

#### Time series plot

This information is not recorded by the Covid Tracking project for the state of texas because the Texas did not apparently record this data.  So there is not time series plot.


### Patients currently on ventalator 

Currently on ventilator

API field name: $onVentilatorCurrently$

#### Definition

Individuals who are currently hospitalized under advanced ventilation with COVID-19. Definitions vary by state / territory. Where possible, we report patients on ventilation with confirmed or probable COVID-19 cases per the expanded CSTE case definition of April 5th, 2020 approved by the CDC.

The statistic is not present in the data fro the state of Texas.  There is no time series plot for this statistic.


### Cumulative on ventilator  

#### Definition

API field name: $onVentilatorCumulative$

Total number of individuals who have ever been hospitalized under advanced ventilation with COVID-19. Definitions vary by state / territory. Where possible, we report patients on ventilation with confirmed or probable COVID-19 cases per the expanded CSTE case definition of April 5th, 2020 approved by the CDC.

##### Time series plot

Texas does nor report this data so no plots are drawn for it.